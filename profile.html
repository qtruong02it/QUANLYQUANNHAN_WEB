<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>H·ªì s∆° qu√¢n nh√¢n</title>
    <link rel="stylesheet" href="css/profile.css">
</head>

<body>
    <button onclick="location.href='index.html'">‚Üê Tr·ªü v·ªÅ</button>
    <div id="profile"></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzEyyRXAESj6LPw8AZiudlOnSdoR4-WIYys_pMn8kToBYgImyoDm-vabvAjEJDN8VYZ-w/exec";
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");
        const profileDiv = document.getElementById("profile");

        if (!id) {
            profileDiv.innerHTML = "<p>‚ùå Thi·∫øu m√£ qu√¢n nh√¢n!</p>";
        } else {
            const CORRECT_PASSWORD = "080304";
            const inputPass = prompt("üîí Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ xem h·ªì s∆°:");
            if (inputPass !== CORRECT_PASSWORD) {
                profileDiv.innerHTML = "<p style='color:red;font-weight:bold;'>‚ùå M·∫≠t kh·∫©u sai! Kh√¥ng th·ªÉ xem h·ªì s∆°.</p>";
            } else {
                loadProfile();
            }
        }

        async function loadProfile() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                const qn = data.find(x => x.MaQN === id);
                if (!qn) return (profileDiv.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y h·ªì s∆° qu√¢n nh√¢n.</p>");
                renderProfile(qn);
            } catch (err) {
                profileDiv.innerHTML = `<p style='color:red;'>L·ªói t·∫£i d·ªØ li·ªáu: ${err}</p>`;
            }
        }

        function renderProfile(qn) {
            const formatDate = (dateStr) => {
                if (!dateStr) return "";
                return new Date(dateStr).toLocaleDateString("vi-VN", {
                    timeZone: "Asia/Ho_Chi_Minh",
                    day: "2-digit",
                    month: "2-digit",
                    year: "numeric"
                });
            };

            const avatar = qn.HinhAnh?.[0]?.URLAnh || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            const cover = "https://images.unsplash.com/photo-1527980965255-d3b416303d12?w=1200&q=80";

            profileDiv.innerHTML = `
    <div class="cover-photo">
      <img src="${cover}" alt="·∫¢nh b√¨a">
      <div class="avatar"><img src="${avatar}" alt="·∫¢nh ƒë·∫°i di·ªán"></div>
    </div>

    <div class="profile-header">
      <h1>${qn.HoTen || "Kh√¥ng r√µ t√™n"}</h1>
      <p>${qn.ChucVu || ""} ‚Ä¢ ${qn.DonVi || ""}</p>
    </div>

    <div class="profile-body">
      <div class="profile-sidebar">
        <h2>Gi·ªõi thi·ªáu</h2>
        <p><strong>M√£:</strong> ${qn.MaQN || ""}</p>
        <p><strong>Ng√†y sinh:</strong> ${formatDate(qn.NgaySinh)}</p>
        <p><strong>Qu√™ qu√°n:</strong> ${qn.QueQuan || ""}</p>
        <p><strong>R√®n luy·ªán:</strong> ${qn.THRenLuyen || ""}</p>
      </div>

      <div class="profile-content">
        <h2>Nh·∫≠n x√©t</h2>
        <div id="nhanxet-list">
          ${(qn.NhanXet || []).map((n, i) => `
            <div class="post">
              <div class="post-header">
                <img class="post-avatar" src="${avatar}" alt="avatar">
                <div>
                  <h3>${qn.HoTen}</h3>
                  <span>${formatDate(n.NgayDanhGia)}</span>
                </div>
              </div>
              <div class="post-content" id="comment-${i}">${n.NoiDungNX || "Kh√¥ng c√≥ nh·∫≠n x√©t"}</div>
              <div class="actions">
                <button class="edit-btn" onclick="editNhanXet('${qn.MaQN}', ${i}, '${encodeURIComponent(n.NoiDungNX || "")}')">‚úè S·ª≠a</button>
                <button class="delete-btn" onclick="deleteNhanXet('${qn.MaQN}', ${i})">üóë X√≥a</button>
              </div>
            </div>
          `).join("")}
        </div>

        <div class="add-form">
          <textarea id="nhanxet-input" placeholder="Nh·∫≠p nh·∫≠n x√©t m·ªõi..."></textarea>
          <button onclick="addNhanXet('${qn.MaQN}')">‚ûï Th√™m nh·∫≠n x√©t</button>
        </div>

        <h2>H√¨nh ·∫£nh</h2>
        <div class="images" id="image-list">
          ${(qn.HinhAnh || []).map((h, i) => `
            <div class="img-box">
              <img src="${h.URLAnh}" alt="·∫¢nh qu√¢n nh√¢n">
              <button class="delete-btn" onclick="deleteHinhAnh('${qn.MaQN}', ${i})">‚úñ</button>
            </div>
          `).join("")}
        </div>

        <div class="add-form">
          <input type="text" id="url-input" placeholder="D√°n URL ·∫£nh...">
          <button onclick="addHinhAnh('${qn.MaQN}')">üì∏ Th√™m ·∫£nh</button>
        </div>
      </div>
    </div>
  `;
        }

        /* ====================== CRUD ====================== */

        async function addNhanXet(MaQN) {
            const text = document.getElementById("nhanxet-input").value.trim();
            if (!text) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung nh·∫≠n x√©t!");
            const body = { action: "add_nhanxet", data: { MaQN, NoiDungNX: text, NgayDanhGia: new Date().toISOString() } };

            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
            });
            const data = await res.json();
            if (data.ok) {
                alert("‚úÖ ƒê√£ th√™m nh·∫≠n x√©t!");
                loadProfile();
            } else alert("‚ùå " + data.message);
        }

        async function editNhanXet(MaQN, index, oldTextEncoded) {
            const oldText = decodeURIComponent(oldTextEncoded);
            const newText = prompt("‚úè Nh·∫≠p n·ªôi dung m·ªõi cho nh·∫≠n x√©t:", oldText);
            if (newText === null) return; // b·∫•m Cancel
            const body = { action: "edit_nhanxet", MaQN, index, NoiDungNX: newText };

            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
            });
            const data = await res.json();
            if (data.ok) {
                alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t nh·∫≠n x√©t!");
                loadProfile();
            } else alert("‚ùå " + data.message);
        }

        async function deleteNhanXet(MaQN, index) {
            if (!confirm("X√≥a nh·∫≠n x√©t n√†y?")) return;
            const body = { action: "delete_nhanxet", MaQN, index };
            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
            });
            const data = await res.json();
            if (data.ok) {
                alert("üóë ƒê√£ x√≥a nh·∫≠n x√©t!");
                loadProfile();
            } else alert("‚ùå " + data.message);
        }

        async function addHinhAnh(MaQN) {
            const url = document.getElementById("url-input").value.trim();
            if (!url) return alert("Nh·∫≠p URL ·∫£nh!");
            const body = { action: "add_hinhanh", data: { MaQN, URLAnh: url } };
            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
            });
            const data = await res.json();
            if (data.ok) {
                alert("üì∏ ·∫¢nh ƒë√£ ƒë∆∞·ª£c th√™m!");
                loadProfile();
            } else alert("‚ùå " + data.message);
        }

        async function deleteHinhAnh(MaQN, index) {
            if (!confirm("X√≥a ·∫£nh n√†y?")) return;
            const body = { action: "delete_hinhanh", MaQN, index };
            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
            });
            const data = await res.json();
            if (data.ok) {
                alert("üóë ƒê√£ x√≥a ·∫£nh!");
                loadProfile();
            } else alert("‚ùå " + data.message);
        }
    </script>

</body>

</html>
